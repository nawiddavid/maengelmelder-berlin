<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sachbearbeiter | M√§ngelmelder Berlin</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    /* Berlin Corporate Design - Sachbearbeiter-Portal */
    body {
      background: var(--berlin-gray-100);
    }
    
    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }
    
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
      background: var(--berlin-white);
      padding: 1.5rem;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      border-left: 4px solid var(--berlin-red);
    }
    
    .admin-header h1 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--berlin-gray-900);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .admin-header h1::before {
      content: '‚öôÔ∏è';
    }
    
    .admin-user {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .admin-user-name {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--berlin-gray-50);
      border-radius: var(--radius-md);
      font-weight: 600;
      color: var(--berlin-gray-700);
    }
    
    .admin-user-name::before {
      content: 'üë§';
    }
    
    /* Stats Grid - Berlin Style */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: var(--berlin-white);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      text-align: center;
      box-shadow: var(--shadow-md);
      transition: all 0.2s ease;
      border-top: 4px solid var(--berlin-gray-300);
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .stat-card:first-child {
      border-top-color: var(--berlin-red);
    }
    
    .stat-card:nth-child(2) {
      border-top-color: #FFC107;
    }
    
    .stat-card:nth-child(3) {
      border-top-color: #17A2B8;
    }
    
    .stat-card:nth-child(4) {
      border-top-color: #6F42C1;
    }
    
    .stat-card:nth-child(5) {
      border-top-color: #28A745;
    }
    
    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--berlin-gray-900);
      line-height: 1;
    }
    
    .stat-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--berlin-gray-500);
      margin-top: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-icon {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }
    
    /* Filters - Berlin Style */
    .filters {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--berlin-gray-50);
      border-radius: var(--radius-md);
    }
    
    .filters select,
    .filters input[type="date"] {
      padding: 0.625rem 1rem;
      border: 2px solid var(--berlin-gray-300);
      border-radius: var(--radius-md);
      background: var(--berlin-white);
      color: var(--berlin-gray-800);
      font-family: inherit;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    
    .filters select:focus,
    .filters input[type="date"]:focus {
      outline: none;
      border-color: var(--berlin-red);
      box-shadow: 0 0 0 3px rgba(226, 0, 26, 0.1);
    }
    
    /* Reports Table - Berlin Style */
    .reports-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .reports-table th {
      padding: 1rem 0.75rem;
      text-align: left;
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--berlin-gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--berlin-gray-200);
      background: var(--berlin-gray-50);
    }
    
    .reports-table td {
      padding: 1rem 0.75rem;
      border-bottom: 1px solid var(--berlin-gray-200);
      color: var(--berlin-gray-800);
    }
    
    .reports-table tr.clickable {
      cursor: pointer;
      transition: background 0.2s ease;
    }
    
    .reports-table tr.clickable:hover td {
      background: var(--berlin-gray-50);
    }
    
    .reports-table .ticket-id {
      font-weight: 600;
      color: var(--berlin-red);
    }
    
    /* Status Badges - Berlin Style */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.375rem 0.75rem;
      border-radius: 100px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    .status-badge.SUBMITTED { 
      background: #FFF3CD; 
      color: #856404; 
    }
    .status-badge.FORWARDED { 
      background: #D1ECF1; 
      color: #0C5460; 
    }
    .status-badge.IN_PROGRESS { 
      background: #E2D5F1; 
      color: #5A3E85; 
    }
    .status-badge.DONE { 
      background: #D4EDDA; 
      color: #155724; 
    }
    
    .urgency-HIGH { 
      color: #DC3545;
      font-weight: 600;
    }
    
    /* Pagination - Berlin Style */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--berlin-gray-200);
    }
    
    .pagination button {
      padding: 0.5rem 1rem;
      border: 2px solid var(--berlin-gray-300);
      border-radius: var(--radius-md);
      background: var(--berlin-white);
      color: var(--berlin-gray-700);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .pagination button:hover:not(:disabled) {
      border-color: var(--berlin-red);
      color: var(--berlin-red);
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination button.active {
      background: var(--berlin-red);
      border-color: var(--berlin-red);
      color: var(--berlin-white);
    }
    
    /* Modal - Berlin Style */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      overflow-y: auto;
      backdrop-filter: blur(4px);
    }
    
    .modal.active {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 2rem;
    }
    
    .modal-content {
      background: var(--berlin-white);
      border-radius: var(--radius-lg);
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      border-bottom: 2px solid var(--berlin-gray-200);
      background: var(--berlin-gray-50);
    }
    
    .modal-header h3 {
      margin: 0;
      color: var(--berlin-red);
      font-size: 1.25rem;
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--berlin-gray-500);
      font-size: 1.75rem;
      cursor: pointer;
      line-height: 1;
      padding: 0;
      transition: color 0.2s ease;
    }
    
    .modal-close:hover {
      color: var(--berlin-red);
    }
    
    .detail-row {
      display: flex;
      padding: 0.875rem 0;
      border-bottom: 1px solid var(--berlin-gray-200);
    }
    
    .detail-row:last-child {
      border-bottom: none;
    }
    
    .detail-row .label {
      width: 150px;
      color: var(--berlin-gray-500);
      font-weight: 600;
      flex-shrink: 0;
    }
    
    .detail-row .value {
      color: var(--berlin-gray-800);
    }
    
    .detail-row a {
      color: var(--berlin-red);
    }
    
    .detail-photos {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin: 1rem 0;
    }
    
    .detail-photos img {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border: 2px solid var(--berlin-gray-200);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .detail-photos img:hover {
      border-color: var(--berlin-red);
      box-shadow: var(--shadow-md);
    }
    
    /* Weiterleitung Section */
    .forward-section {
      margin-top: 1.5rem;
      padding: 1.5rem;
      background: linear-gradient(135deg, #E7F5FF 0%, #D0EBFF 100%);
      border: 2px solid #74C0FC;
      border-radius: var(--radius-lg);
    }
    
    .forward-section h4 {
      margin: 0 0 1rem;
      color: #1864AB;
      font-size: 1rem;
    }
    
    .forward-form {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .forward-form select {
      padding: 0.75rem 1rem;
      border: 2px solid #74C0FC;
      border-radius: var(--radius-md);
      background: var(--berlin-white);
      color: var(--berlin-gray-800);
      font-family: inherit;
      font-size: 1rem;
    }
    
    .forward-form select:focus {
      outline: none;
      border-color: #228BE6;
      box-shadow: 0 0 0 3px rgba(34, 139, 230, 0.2);
    }
    
    .forward-form textarea {
      padding: 0.75rem 1rem;
      border: 2px solid #74C0FC;
      border-radius: var(--radius-md);
      background: var(--berlin-white);
      color: var(--berlin-gray-800);
      font-family: inherit;
      font-size: 0.95rem;
      resize: vertical;
      min-height: 60px;
    }
    
    .forward-form textarea:focus {
      outline: none;
      border-color: #228BE6;
    }
    
    .forward-form .btn {
      background: #228BE6;
      align-self: flex-start;
    }
    
    .forward-form .btn:hover {
      background: #1864AB;
    }
    
    /* Detail Actions */
    .detail-actions {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 2px solid var(--berlin-gray-200);
    }
    
    .action-group {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    .action-group label {
      font-weight: 600;
      color: var(--berlin-gray-600);
      font-size: 0.9rem;
      min-width: 140px;
    }
    
    .detail-actions select {
      padding: 0.5rem 1rem;
      border: 2px solid var(--berlin-gray-300);
      border-radius: var(--radius-md);
      background: var(--berlin-white);
      color: var(--berlin-gray-800);
      font-family: inherit;
      min-width: 200px;
    }
    
    .detail-actions select:focus {
      outline: none;
      border-color: var(--berlin-red);
    }
    
    .audit-log {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 2px solid var(--berlin-gray-200);
    }
    
    .audit-log h4 {
      margin: 0 0 1rem;
      color: var(--berlin-gray-700);
      font-size: 1rem;
    }
    
    .audit-item {
      padding: 0.75rem;
      font-size: 0.9rem;
      border-left: 3px solid var(--berlin-gray-300);
      margin-bottom: 0.5rem;
      background: var(--berlin-gray-50);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }
    
    .audit-item strong {
      color: var(--berlin-gray-800);
    }
    
    .audit-item .meta {
      font-size: 0.8rem;
      color: var(--berlin-gray-500);
      margin-top: 0.25rem;
    }
    
    .description-box {
      background: var(--berlin-gray-50);
      padding: 1rem;
      border-radius: var(--radius-md);
      border-left: 4px solid var(--berlin-red);
      margin-top: 0.5rem;
      color: var(--berlin-gray-800);
    }
    
    @media (max-width: 768px) {
      .admin-container {
        padding: 1rem;
      }
      
      .reports-table {
        font-size: 0.85rem;
      }
      
      .reports-table th:nth-child(4),
      .reports-table td:nth-child(4),
      .reports-table th:nth-child(5),
      .reports-table td:nth-child(5) {
        display: none;
      }
      
      .detail-row {
        flex-direction: column;
        gap: 0.25rem;
      }
      
      .detail-row .label {
        width: auto;
      }
    }
  </style>
</head>
<body>
  <!-- Berlin Header -->
  <header class="berlin-header">
    <div class="berlin-header__inner">
      <a href="/" class="berlin-logo">
        <div class="berlin-logo__bear">üêª</div>
        <div class="berlin-logo__text">
          M√§ngelmelder
          <span>Stadt Berlin</span>
        </div>
      </a>
    </div>
  </header>
  
  <div class="admin-container">
    <div class="admin-header">
      <h1>üèõÔ∏è Sachbearbeiter-Portal</h1>
      <div class="admin-user">
        <span class="admin-user-name" id="adminName">-</span>
        <button class="btn btn--ghost" id="logoutBtn">Abmelden</button>
      </div>
    </div>
    
    <!-- Stats -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-value" id="statTotal">-</div>
        <div class="stat-label">Gesamt</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üì•</div>
        <div class="stat-value" id="statSubmitted">-</div>
        <div class="stat-label">Eingereicht</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üì§</div>
        <div class="stat-value" id="statForwarded">-</div>
        <div class="stat-label">Weitergeleitet</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üîß</div>
        <div class="stat-value" id="statInProgress">-</div>
        <div class="stat-label">In Bearbeitung</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-value" id="statDone">-</div>
        <div class="stat-label">Erledigt</div>
      </div>
    </div>
    
    <div class="card">
      <div class="card__header">
        <h2>üìã Meldungen</h2>
        <div style="display: flex; gap: 0.5rem;">
          <button class="btn btn--ghost" id="exportCsvBtn">üì• CSV</button>
          <button class="btn btn--ghost" id="exportJsonBtn">üì• JSON</button>
        </div>
      </div>
      
      <!-- Filters -->
      <div class="filters">
        <select id="filterStatus">
          <option value="">Alle Status</option>
          <option value="SUBMITTED">Eingereicht</option>
          <option value="FORWARDED">Weitergeleitet</option>
          <option value="IN_PROGRESS">In Bearbeitung</option>
          <option value="DONE">Erledigt</option>
        </select>
        <select id="filterCategory">
          <option value="">Alle Kategorien</option>
          <option value="TRASH">üóëÔ∏è M√ºll</option>
          <option value="DAMAGE">üöß Sch√§den</option>
          <option value="VANDALISM">üé® Vandalismus</option>
          <option value="OTHER">‚ùì Sonstiges</option>
        </select>
        <input type="date" id="filterFrom" title="Von">
        <input type="date" id="filterTo" title="Bis">
        <button class="btn" id="applyFilters">üîç Filtern</button>
      </div>
      
      <!-- Table -->
      <div style="overflow-x: auto;">
        <table class="reports-table">
          <thead>
            <tr>
              <th>Ticket-ID</th>
              <th>Kategorie</th>
              <th>Status</th>
              <th>Bezirk</th>
              <th>Erstellt</th>
              <th>Dringlichkeit</th>
            </tr>
          </thead>
          <tbody id="reportsTableBody">
            <tr><td colspan="6" style="text-align: center; padding: 2rem;">Laden...</td></tr>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <div class="pagination" id="pagination"></div>
    </div>
  </div>
  
  <!-- Footer -->
  <footer class="footer">
    <div>¬© 2026 Stadt Berlin ‚Äì M√§ngelmelder Admin</div>
  </footer>
  
  <!-- Detail Modal -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTicketId">-</h3>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Dynamisch gef√ºllt -->
      </div>
    </div>
  </div>
  
  <script>
    const STATUS_LABELS = {
      'SUBMITTED': 'Eingereicht',
      'FORWARDED': 'Weitergeleitet',
      'IN_PROGRESS': 'In Bearbeitung',
      'DONE': 'Erledigt'
    };
    
    const CATEGORY_LABELS = {
      'TRASH': 'üóëÔ∏è M√ºll',
      'DAMAGE': 'üöß Sch√§den',
      'VANDALISM': 'üé® Vandalismus',
      'OTHER': '‚ùì Sonstiges'
    };
    
    // Zust√§ndige Stellen f√ºr Weiterleitung
    const AUTHORITIES = {
      'BSR': { name: 'Berliner Stadtreinigung (BSR)', email: 'service@bsr.de', categories: ['TRASH'] },
      'STRASSENAMT': { name: 'Stra√üen- und Gr√ºnfl√§chenamt', email: 'strassenamt@berlin.de', categories: ['DAMAGE', 'VANDALISM'] },
      'TIEFBAU': { name: 'Tiefbauamt', email: 'tiefbau@berlin.de', categories: ['DAMAGE'] },
      'GRUENFLAECHEN': { name: 'Gr√ºnfl√§chenamt', email: 'gruenflaechen@berlin.de', categories: ['DAMAGE', 'VANDALISM', 'TRASH'] },
      'ORDNUNGSAMT': { name: 'Ordnungsamt', email: 'ordnungsamt@berlin.de', categories: ['TRASH', 'VANDALISM', 'OTHER'] },
      'POLIZEI': { name: 'Polizei Berlin (Meldestelle)', email: 'hinweise@polizei.berlin.de', categories: ['VANDALISM'] },
      'LICHTAMT': { name: 'Amt f√ºr Beleuchtung', email: 'licht@berlin.de', categories: ['DAMAGE'] },
      'VERKEHR': { name: 'Verkehrslenkung Berlin', email: 'vlb@berlin.de', categories: ['DAMAGE'] },
      'BUERGERAMT': { name: 'B√ºrgeramt', email: 'buergeramt@berlin.de', categories: ['OTHER'] }
    };
    
    // Zust√§ndige Stellen f√ºr eine Kategorie ermitteln
    function getAuthoritiesForCategory(category) {
      return Object.entries(AUTHORITIES)
        .filter(([key, auth]) => auth.categories.includes(category))
        .map(([key, auth]) => ({ key, ...auth }));
    }
    
    let currentAdmin = null;
    let currentPage = 1;
    
    // Auth pr√ºfen
    checkAuth();
    
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/me');
        if (!response.ok) {
          window.location.href = '/admin/login.html';
          return;
        }
        currentAdmin = await response.json();
        document.getElementById('adminName').textContent = currentAdmin.name;
        
        loadStats();
        loadReports();
      } catch (e) {
        window.location.href = '/admin/login.html';
      }
    }
    
    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/api/auth/logout', { method: 'POST' });
      window.location.href = '/admin/login.html';
    });
    
    // Stats laden
    async function loadStats() {
      try {
        const response = await fetch('/api/admin/stats');
        const stats = await response.json();
        
        document.getElementById('statTotal').textContent = stats.total;
        document.getElementById('statSubmitted').textContent = stats.byStatus.SUBMITTED || 0;
        document.getElementById('statForwarded').textContent = stats.byStatus.FORWARDED || 0;
        document.getElementById('statInProgress').textContent = stats.byStatus.IN_PROGRESS || 0;
        document.getElementById('statDone').textContent = stats.byStatus.DONE || 0;
      } catch (e) {
        console.error('Failed to load stats:', e);
      }
    }
    
    // Reports laden
    async function loadReports(page = 1) {
      currentPage = page;
      
      const params = new URLSearchParams();
      params.set('page', page);
      params.set('limit', 20);
      
      const status = document.getElementById('filterStatus').value;
      const category = document.getElementById('filterCategory').value;
      const from = document.getElementById('filterFrom').value;
      const to = document.getElementById('filterTo').value;
      
      if (status) params.set('status', status);
      if (category) params.set('category', category);
      if (from) params.set('from', from);
      if (to) params.set('to', to);
      
      try {
        const response = await fetch(`/api/admin/reports?${params}`);
        const result = await response.json();
        
        renderReports(result.data);
        renderPagination(result.pagination);
      } catch (e) {
        console.error('Failed to load reports:', e);
      }
    }
    
    function renderReports(reports) {
      const tbody = document.getElementById('reportsTableBody');
      
      if (reports.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--berlin-gray-500);">Keine Meldungen gefunden</td></tr>';
        return;
      }
      
      tbody.innerHTML = reports.map(report => `
        <tr class="clickable" data-id="${report.id}">
          <td class="ticket-id">${report.ticketId}</td>
          <td>${CATEGORY_LABELS[report.category] || report.category}</td>
          <td><span class="status-badge ${report.status}">${STATUS_LABELS[report.status]}</span></td>
          <td>${report.district || '-'}</td>
          <td>${formatDate(report.createdAt)}</td>
          <td class="${report.urgency === 'HIGH' ? 'urgency-HIGH' : ''}">${report.urgency === 'HIGH' ? '‚ö†Ô∏è ' : ''}${report.urgency}</td>
        </tr>
      `).join('');
      
      // Click Handler
      tbody.querySelectorAll('tr.clickable').forEach(row => {
        row.addEventListener('click', () => openDetail(row.dataset.id));
      });
    }
    
    function renderPagination(pagination) {
      const container = document.getElementById('pagination');
      const { page, totalPages } = pagination;
      
      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }
      
      let html = '';
      
      html += `<button ${page === 1 ? 'disabled' : ''} data-page="${page - 1}">‚Üê Zur√ºck</button>`;
      
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= page - 2 && i <= page + 2)) {
          html += `<button class="${i === page ? 'active' : ''}" data-page="${i}">${i}</button>`;
        } else if (i === page - 3 || i === page + 3) {
          html += `<span style="padding: 0 0.5rem; color: var(--berlin-gray-400);">...</span>`;
        }
      }
      
      html += `<button ${page === totalPages ? 'disabled' : ''} data-page="${page + 1}">Weiter ‚Üí</button>`;
      
      container.innerHTML = html;
      
      container.querySelectorAll('button[data-page]').forEach(btn => {
        btn.addEventListener('click', () => loadReports(parseInt(btn.dataset.page)));
      });
    }
    
    // Filter
    document.getElementById('applyFilters').addEventListener('click', () => loadReports(1));
    
    // Export
    document.getElementById('exportCsvBtn').addEventListener('click', () => exportReports('csv'));
    document.getElementById('exportJsonBtn').addEventListener('click', () => exportReports('json'));
    
    async function exportReports(format) {
      const params = new URLSearchParams();
      params.set('format', format);
      
      const status = document.getElementById('filterStatus').value;
      const category = document.getElementById('filterCategory').value;
      const from = document.getElementById('filterFrom').value;
      const to = document.getElementById('filterTo').value;
      
      if (status) params.set('status', status);
      if (category) params.set('category', category);
      if (from) params.set('from', from);
      if (to) params.set('to', to);
      
      window.open(`/api/admin/export?${params}`, '_blank');
    }
    
    // Detail Modal
    const modal = document.getElementById('detailModal');
    document.getElementById('closeModal').addEventListener('click', () => modal.classList.remove('active'));
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.classList.remove('active');
    });
    
    async function openDetail(id) {
      try {
        const response = await fetch(`/api/admin/reports/${id}`);
        const report = await response.json();
        
        document.getElementById('modalTicketId').textContent = 'üé´ ' + report.ticketId;
        
        const body = document.getElementById('modalBody');
        body.innerHTML = `
          <div class="detail-row">
            <span class="label">Status</span>
            <span class="value"><span class="status-badge ${report.status}">${STATUS_LABELS[report.status]}</span></span>
          </div>
          <div class="detail-row">
            <span class="label">Kategorie</span>
            <span class="value">${CATEGORY_LABELS[report.category]}</span>
          </div>
          <div class="detail-row">
            <span class="label">Dringlichkeit</span>
            <span class="value ${report.urgency === 'HIGH' ? 'urgency-HIGH' : ''}">${report.urgency === 'HIGH' ? '‚ö†Ô∏è ' : ''}${report.urgency}</span>
          </div>
          <div class="detail-row">
            <span class="label">Standort</span>
            <span class="value">
              ${report.address || '-'}<br>
              <a href="https://www.google.com/maps?q=${report.latitude},${report.longitude}" target="_blank">üìç Auf Karte anzeigen</a>
            </span>
          </div>
          <div class="detail-row">
            <span class="label">Bezirk</span>
            <span class="value">${report.district || '-'}</span>
          </div>
          <div class="detail-row">
            <span class="label">Erstellt</span>
            <span class="value">${formatDate(report.createdAt)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Kontakt</span>
            <span class="value">${report.contactEmail ? `<a href="mailto:${report.contactEmail}">${report.contactEmail}</a>` : '-'}</span>
          </div>
          
          <div style="margin-top: 1.5rem;">
            <strong style="color: var(--berlin-gray-700);">üìù Beschreibung:</strong>
            <div class="description-box">${report.comment}</div>
          </div>
          
          ${report.photos && report.photos.length > 0 ? `
            <div style="margin-top: 1.5rem;">
              <strong style="color: var(--berlin-gray-700);">üì∑ Fotos:</strong>
              <div class="detail-photos">
                ${report.photos.map(p => `<img src="/uploads/${p.storagePath.split('/').pop()}" alt="${p.filename}">`).join('')}
              </div>
            </div>
          ` : ''}
          
          ${currentAdmin.role === 'ADMIN' ? `
            <!-- Weiterleitung an zust√§ndige Stelle -->
            ${report.status === 'SUBMITTED' ? `
              <div class="forward-section">
                <h4>üì§ An zust√§ndige Stelle weiterleiten</h4>
                <div class="forward-form">
                  <select id="authoritySelect">
                    <option value="">-- Zust√§ndige Stelle ausw√§hlen --</option>
                    ${getAuthoritiesForCategory(report.category).map(auth => 
                      `<option value="${auth.key}">${auth.name}</option>`
                    ).join('')}
                    <optgroup label="Weitere Stellen">
                      ${Object.entries(AUTHORITIES)
                        .filter(([key, auth]) => !auth.categories.includes(report.category))
                        .map(([key, auth]) => `<option value="${key}">${auth.name}</option>`)
                        .join('')}
                    </optgroup>
                  </select>
                  <textarea id="forwardComment" placeholder="Optionaler Kommentar zur Weiterleitung..." rows="2"></textarea>
                  <button class="btn" onclick="forwardToAuthority('${report.id}', '${report.category}')">
                    üì§ Weiterleiten
                  </button>
                </div>
              </div>
            ` : ''}
            
            <!-- Status √§ndern -->
            <div class="detail-actions">
              <div class="action-group">
                <label>Status √§ndern:</label>
                <select id="statusSelect">
                  <option value="SUBMITTED" ${report.status === 'SUBMITTED' ? 'selected' : ''}>üì• Eingereicht</option>
                  <option value="FORWARDED" ${report.status === 'FORWARDED' ? 'selected' : ''}>üì§ Weitergeleitet</option>
                  <option value="IN_PROGRESS" ${report.status === 'IN_PROGRESS' ? 'selected' : ''}>üîß In Bearbeitung</option>
                  <option value="DONE" ${report.status === 'DONE' ? 'selected' : ''}>‚úÖ Erledigt</option>
                </select>
                <button class="btn btn--sm" onclick="changeStatus('${report.id}')">Speichern</button>
              </div>
              
              ${report.status === 'FORWARDED' || report.status === 'IN_PROGRESS' ? `
                <div class="action-group">
                  <label>Erneut weiterleiten:</label>
                  <select id="reforwardSelect">
                    <option value="">-- Andere Stelle --</option>
                    ${Object.entries(AUTHORITIES).map(([key, auth]) => 
                      `<option value="${key}">${auth.name}</option>`
                    ).join('')}
                  </select>
                  <button class="btn btn--sm btn--ghost" onclick="reforward('${report.id}')">üîÑ Weiterleiten</button>
                </div>
              ` : ''}
            </div>
          ` : ''}
          
          <div class="audit-log">
            <h4>üìú Protokoll</h4>
            ${report.auditLogs.map(log => `
              <div class="audit-item">
                <strong>${formatAuditAction(log.action)}</strong>
                ${log.details.recipientName ? ` ‚Üí ${log.details.recipientName}` : ''}
                ${log.details.oldStatus ? ` (${STATUS_LABELS[log.details.oldStatus]} ‚Üí ${STATUS_LABELS[log.details.newStatus]})` : ''}
                <div class="meta">${formatDate(log.timestamp)} ‚Ä¢ ${log.performedBy}</div>
              </div>
            `).join('')}
          </div>
        `;
        
        modal.classList.add('active');
      } catch (e) {
        alert('Fehler beim Laden der Details');
        console.error(e);
      }
    }
    
    async function changeStatus(id) {
      const newStatus = document.getElementById('statusSelect').value;
      
      try {
        const response = await fetch(`/api/admin/reports/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });
        
        if (!response.ok) throw new Error('Fehler beim √Ñndern des Status');
        
        alert('‚úÖ Status erfolgreich ge√§ndert!');
        modal.classList.remove('active');
        loadReports(currentPage);
        loadStats();
      } catch (e) {
        alert('‚ùå Fehler: ' + e.message);
      }
    }
    
    // Meldung an zust√§ndige Stelle weiterleiten
    async function forwardToAuthority(reportId, category) {
      const authorityKey = document.getElementById('authoritySelect').value;
      const comment = document.getElementById('forwardComment').value.trim();
      
      if (!authorityKey) {
        alert('‚ö†Ô∏è Bitte w√§hlen Sie eine zust√§ndige Stelle aus.');
        return;
      }
      
      const authority = AUTHORITIES[authorityKey];
      
      if (!confirm(`Meldung an "${authority.name}" weiterleiten?`)) {
        return;
      }
      
      try {
        const response = await fetch(`/api/admin/reports/${reportId}/forward`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            authorityKey,
            authorityName: authority.name,
            authorityEmail: authority.email,
            comment
          })
        });
        
        const data = await response.json();
        
        if (!response.ok) throw new Error(data.message || 'Fehler bei der Weiterleitung');
        
        alert(`‚úÖ Meldung erfolgreich an "${authority.name}" weitergeleitet!`);
        modal.classList.remove('active');
        loadReports(currentPage);
        loadStats();
      } catch (e) {
        alert('‚ùå Fehler: ' + e.message);
      }
    }
    
    // Erneute Weiterleitung an andere Stelle
    async function reforward(id) {
      const authorityKey = document.getElementById('reforwardSelect')?.value;
      
      let authority = null;
      if (authorityKey && AUTHORITIES[authorityKey]) {
        authority = AUTHORITIES[authorityKey];
      } else {
        // Fallback: manuelle Eingabe
        const manualInput = prompt('An welche Stelle soll weitergeleitet werden?');
        if (!manualInput) return;
        authority = { name: manualInput, email: '' };
      }
      
      const reason = prompt('Grund f√ºr erneute Weiterleitung:');
      if (!reason) return;
      
      try {
        const response = await fetch(`/api/admin/reports/${id}/reforward`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            reason,
            authorityName: authority.name,
            authorityEmail: authority.email
          })
        });
        
        const data = await response.json();
        
        if (!response.ok) throw new Error(data.message || 'Fehler');
        
        alert(`‚úÖ Meldung erneut an "${authority.name}" weitergeleitet!`);
        modal.classList.remove('active');
        loadReports(currentPage);
      } catch (e) {
        alert('‚ùå Fehler: ' + e.message);
      }
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleDateString('de-DE', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }
    
    function formatAuditAction(action) {
      const labels = {
        'CREATED': 'üìù Erstellt',
        'FORWARDED': 'üì§ Weitergeleitet',
        'STATUS_CHANGED': 'üîÑ Status ge√§ndert',
        'REFORWARDED': 'üîÅ Erneut weitergeleitet',
        'DELETED': 'üóëÔ∏è Gel√∂scht'
      };
      return labels[action] || action;
    }
  </script>
</body>
</html>
