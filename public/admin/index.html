<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | M√§ngelmelder</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .admin-user {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: rgba(0, 20, 0, 0.6);
      border: 1px solid var(--matrix-green-dark);
      padding: 1.25rem;
      text-align: center;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--matrix-green);
    }
    
    .stat-label {
      font-size: 0.85rem;
      color: var(--matrix-green-dark);
      margin-top: 0.25rem;
    }
    
    .filters {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }
    
    .filters select,
    .filters input {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--matrix-green-dark);
      background: rgba(0, 10, 0, 0.8);
      color: var(--matrix-green);
      font-family: inherit;
      font-size: 0.9rem;
    }
    
    .filters select:focus,
    .filters input:focus {
      outline: none;
      border-color: var(--matrix-green);
    }
    
    .reports-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .reports-table th,
    .reports-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid rgba(0, 255, 65, 0.2);
    }
    
    .reports-table th {
      font-size: 0.85rem;
      color: var(--matrix-green-dark);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .reports-table tr:hover td {
      background: rgba(0, 255, 65, 0.05);
    }
    
    .reports-table .clickable {
      cursor: pointer;
    }
    
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border: 1px solid;
      font-size: 0.75rem;
      text-transform: uppercase;
    }
    
    .status-badge.SUBMITTED { border-color: #ffaa00; color: #ffaa00; }
    .status-badge.FORWARDED { border-color: #00aaff; color: #00aaff; }
    .status-badge.IN_PROGRESS { border-color: #aa00ff; color: #aa00ff; }
    .status-badge.DONE { border-color: var(--matrix-green); color: var(--matrix-green); }
    
    .urgency-HIGH { color: #ffaa00; }
    
    .pagination {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }
    
    .pagination button {
      padding: 0.5rem 1rem;
      border: 1px solid var(--matrix-green-dark);
      background: transparent;
      color: var(--matrix-green);
      cursor: pointer;
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination button.active {
      background: var(--matrix-green);
      color: var(--matrix-bg);
    }
    
    /* Detail Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      overflow-y: auto;
    }
    
    .modal.active {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 2rem;
    }
    
    .modal-content {
      background: var(--matrix-bg);
      border: 1px solid var(--matrix-green);
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--matrix-green-dark);
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--matrix-green);
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    .detail-row {
      display: flex;
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(0, 255, 65, 0.1);
    }
    
    .detail-row .label {
      width: 140px;
      color: var(--matrix-green-dark);
      flex-shrink: 0;
    }
    
    .detail-photos {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin: 1rem 0;
    }
    
    .detail-photos img {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border: 1px solid var(--matrix-green-dark);
      cursor: pointer;
    }
    
    .detail-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--matrix-green-dark);
    }
    
    .audit-log {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--matrix-green-dark);
    }
    
    .audit-log h4 {
      margin-bottom: 1rem;
      color: var(--matrix-green-dark);
    }
    
    .audit-item {
      padding: 0.5rem 0;
      font-size: 0.9rem;
      border-bottom: 1px solid rgba(0, 255, 65, 0.1);
    }
    
    @media (max-width: 768px) {
      .reports-table {
        font-size: 0.85rem;
      }
      
      .reports-table th:nth-child(4),
      .reports-table td:nth-child(4),
      .reports-table th:nth-child(5),
      .reports-table td:nth-child(5) {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="matrix-rain"></div>
  
  <div class="page">
    <div class="admin-header">
      <h1 style="margin: 0;">M√§ngelmelder Admin</h1>
      <div class="admin-user">
        <span id="adminName">-</span>
        <button class="btn btn--ghost" id="logoutBtn">Abmelden</button>
      </div>
    </div>
    
    <!-- Stats -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-value" id="statTotal">-</div>
        <div class="stat-label">Gesamt</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statSubmitted">-</div>
        <div class="stat-label">Eingereicht</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statForwarded">-</div>
        <div class="stat-label">Weitergeleitet</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statInProgress">-</div>
        <div class="stat-label">In Bearbeitung</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statDone">-</div>
        <div class="stat-label">Erledigt</div>
      </div>
    </div>
    
    <div class="card">
      <div class="card__header">
        <h2>Meldungen</h2>
        <div style="display: flex; gap: 0.5rem;">
          <button class="btn btn--ghost" id="exportCsvBtn">CSV Export</button>
          <button class="btn btn--ghost" id="exportJsonBtn">JSON Export</button>
        </div>
      </div>
      
      <!-- Filters -->
      <div class="filters">
        <select id="filterStatus">
          <option value="">Alle Status</option>
          <option value="SUBMITTED">Eingereicht</option>
          <option value="FORWARDED">Weitergeleitet</option>
          <option value="IN_PROGRESS">In Bearbeitung</option>
          <option value="DONE">Erledigt</option>
        </select>
        <select id="filterCategory">
          <option value="">Alle Kategorien</option>
          <option value="TRASH">M√ºll</option>
          <option value="DAMAGE">Sch√§den</option>
          <option value="VANDALISM">Vandalismus</option>
          <option value="OTHER">Sonstiges</option>
        </select>
        <input type="date" id="filterFrom" placeholder="Von">
        <input type="date" id="filterTo" placeholder="Bis">
        <button class="btn" id="applyFilters">Filtern</button>
      </div>
      
      <!-- Table -->
      <div style="overflow-x: auto;">
        <table class="reports-table">
          <thead>
            <tr>
              <th>Ticket-ID</th>
              <th>Kategorie</th>
              <th>Status</th>
              <th>Bezirk</th>
              <th>Erstellt</th>
              <th>Dringlichkeit</th>
            </tr>
          </thead>
          <tbody id="reportsTableBody">
            <tr><td colspan="6" style="text-align: center;">Laden...</td></tr>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <div class="pagination" id="pagination"></div>
    </div>
  </div>
  
  <!-- Detail Modal -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTicketId">-</h3>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Dynamisch gef√ºllt -->
      </div>
    </div>
  </div>
  
  <script>
    const STATUS_LABELS = {
      'SUBMITTED': 'Eingereicht',
      'FORWARDED': 'Weitergeleitet',
      'IN_PROGRESS': 'In Bearbeitung',
      'DONE': 'Erledigt'
    };
    
    const CATEGORY_LABELS = {
      'TRASH': 'üóëÔ∏è M√ºll',
      'DAMAGE': 'üöß Sch√§den',
      'VANDALISM': 'üé® Vandalismus',
      'OTHER': '‚ùì Sonstiges'
    };
    
    let currentAdmin = null;
    let currentPage = 1;
    
    // Auth pr√ºfen
    checkAuth();
    
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/me');
        if (!response.ok) {
          window.location.href = '/admin/login.html';
          return;
        }
        currentAdmin = await response.json();
        document.getElementById('adminName').textContent = currentAdmin.name;
        
        loadStats();
        loadReports();
      } catch (e) {
        window.location.href = '/admin/login.html';
      }
    }
    
    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/api/auth/logout', { method: 'POST' });
      window.location.href = '/admin/login.html';
    });
    
    // Stats laden
    async function loadStats() {
      try {
        const response = await fetch('/api/admin/stats');
        const stats = await response.json();
        
        document.getElementById('statTotal').textContent = stats.total;
        document.getElementById('statSubmitted').textContent = stats.byStatus.SUBMITTED || 0;
        document.getElementById('statForwarded').textContent = stats.byStatus.FORWARDED || 0;
        document.getElementById('statInProgress').textContent = stats.byStatus.IN_PROGRESS || 0;
        document.getElementById('statDone').textContent = stats.byStatus.DONE || 0;
      } catch (e) {
        console.error('Failed to load stats:', e);
      }
    }
    
    // Reports laden
    async function loadReports(page = 1) {
      currentPage = page;
      
      const params = new URLSearchParams();
      params.set('page', page);
      params.set('limit', 20);
      
      const status = document.getElementById('filterStatus').value;
      const category = document.getElementById('filterCategory').value;
      const from = document.getElementById('filterFrom').value;
      const to = document.getElementById('filterTo').value;
      
      if (status) params.set('status', status);
      if (category) params.set('category', category);
      if (from) params.set('from', from);
      if (to) params.set('to', to);
      
      try {
        const response = await fetch(`/api/admin/reports?${params}`);
        const result = await response.json();
        
        renderReports(result.data);
        renderPagination(result.pagination);
      } catch (e) {
        console.error('Failed to load reports:', e);
      }
    }
    
    function renderReports(reports) {
      const tbody = document.getElementById('reportsTableBody');
      
      if (reports.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Keine Meldungen gefunden</td></tr>';
        return;
      }
      
      tbody.innerHTML = reports.map(report => `
        <tr class="clickable" data-id="${report.id}">
          <td>${report.ticketId}</td>
          <td>${CATEGORY_LABELS[report.category] || report.category}</td>
          <td><span class="status-badge ${report.status}">${STATUS_LABELS[report.status]}</span></td>
          <td>${report.district || '-'}</td>
          <td>${formatDate(report.createdAt)}</td>
          <td class="${report.urgency === 'HIGH' ? 'urgency-HIGH' : ''}">${report.urgency}</td>
        </tr>
      `).join('');
      
      // Click Handler
      tbody.querySelectorAll('tr.clickable').forEach(row => {
        row.addEventListener('click', () => openDetail(row.dataset.id));
      });
    }
    
    function renderPagination(pagination) {
      const container = document.getElementById('pagination');
      const { page, totalPages } = pagination;
      
      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }
      
      let html = '';
      
      html += `<button ${page === 1 ? 'disabled' : ''} data-page="${page - 1}">‚Üê</button>`;
      
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= page - 2 && i <= page + 2)) {
          html += `<button class="${i === page ? 'active' : ''}" data-page="${i}">${i}</button>`;
        } else if (i === page - 3 || i === page + 3) {
          html += `<span style="padding: 0 0.5rem;">...</span>`;
        }
      }
      
      html += `<button ${page === totalPages ? 'disabled' : ''} data-page="${page + 1}">‚Üí</button>`;
      
      container.innerHTML = html;
      
      container.querySelectorAll('button[data-page]').forEach(btn => {
        btn.addEventListener('click', () => loadReports(parseInt(btn.dataset.page)));
      });
    }
    
    // Filter
    document.getElementById('applyFilters').addEventListener('click', () => loadReports(1));
    
    // Export
    document.getElementById('exportCsvBtn').addEventListener('click', () => exportReports('csv'));
    document.getElementById('exportJsonBtn').addEventListener('click', () => exportReports('json'));
    
    async function exportReports(format) {
      const params = new URLSearchParams();
      params.set('format', format);
      
      const status = document.getElementById('filterStatus').value;
      const category = document.getElementById('filterCategory').value;
      const from = document.getElementById('filterFrom').value;
      const to = document.getElementById('filterTo').value;
      
      if (status) params.set('status', status);
      if (category) params.set('category', category);
      if (from) params.set('from', from);
      if (to) params.set('to', to);
      
      window.open(`/api/admin/export?${params}`, '_blank');
    }
    
    // Detail Modal
    const modal = document.getElementById('detailModal');
    document.getElementById('closeModal').addEventListener('click', () => modal.classList.remove('active'));
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.classList.remove('active');
    });
    
    async function openDetail(id) {
      try {
        const response = await fetch(`/api/admin/reports/${id}`);
        const report = await response.json();
        
        document.getElementById('modalTicketId').textContent = report.ticketId;
        
        const body = document.getElementById('modalBody');
        body.innerHTML = `
          <div class="detail-row">
            <span class="label">Status</span>
            <span><span class="status-badge ${report.status}">${STATUS_LABELS[report.status]}</span></span>
          </div>
          <div class="detail-row">
            <span class="label">Kategorie</span>
            <span>${CATEGORY_LABELS[report.category]}</span>
          </div>
          <div class="detail-row">
            <span class="label">Dringlichkeit</span>
            <span class="${report.urgency === 'HIGH' ? 'urgency-HIGH' : ''}">${report.urgency}</span>
          </div>
          <div class="detail-row">
            <span class="label">Standort</span>
            <span>${report.address || '-'}<br>
              <a href="https://www.google.com/maps?q=${report.latitude},${report.longitude}" target="_blank" style="color: var(--matrix-green);">üìç Auf Karte anzeigen</a>
            </span>
          </div>
          <div class="detail-row">
            <span class="label">Bezirk</span>
            <span>${report.district || '-'}</span>
          </div>
          <div class="detail-row">
            <span class="label">Erstellt</span>
            <span>${formatDate(report.createdAt)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Kontakt</span>
            <span>${report.contactEmail ? `<a href="mailto:${report.contactEmail}" style="color: var(--matrix-green);">${report.contactEmail}</a>` : '-'}</span>
          </div>
          
          <div style="margin-top: 1rem;">
            <strong>Beschreibung:</strong>
            <p style="background: rgba(0, 20, 0, 0.6); padding: 1rem; margin-top: 0.5rem;">${report.comment}</p>
          </div>
          
          ${report.photos && report.photos.length > 0 ? `
            <div class="detail-photos">
              ${report.photos.map(p => `<img src="/uploads/${p.storagePath.split('/').pop()}" alt="${p.filename}">`).join('')}
            </div>
          ` : ''}
          
          ${currentAdmin.role === 'ADMIN' ? `
            <div class="detail-actions">
              <select id="statusSelect" style="padding: 0.5rem; border: 1px solid var(--matrix-green-dark); background: var(--matrix-bg); color: var(--matrix-green);">
                <option value="SUBMITTED" ${report.status === 'SUBMITTED' ? 'selected' : ''}>Eingereicht</option>
                <option value="FORWARDED" ${report.status === 'FORWARDED' ? 'selected' : ''}>Weitergeleitet</option>
                <option value="IN_PROGRESS" ${report.status === 'IN_PROGRESS' ? 'selected' : ''}>In Bearbeitung</option>
                <option value="DONE" ${report.status === 'DONE' ? 'selected' : ''}>Erledigt</option>
              </select>
              <button class="btn" onclick="changeStatus('${report.id}')">Status √§ndern</button>
              <button class="btn btn--ghost" onclick="reforward('${report.id}')">Erneut weiterleiten</button>
            </div>
          ` : ''}
          
          <div class="audit-log">
            <h4>Protokoll</h4>
            ${report.auditLogs.map(log => `
              <div class="audit-item">
                <strong>${formatAuditAction(log.action)}</strong>
                ${log.details.recipientName ? ` ‚Üí ${log.details.recipientName}` : ''}
                ${log.details.oldStatus ? ` (${STATUS_LABELS[log.details.oldStatus]} ‚Üí ${STATUS_LABELS[log.details.newStatus]})` : ''}
                <br>
                <span style="font-size: 0.8rem; color: var(--matrix-green-dark);">${formatDate(log.timestamp)} ‚Ä¢ ${log.performedBy}</span>
              </div>
            `).join('')}
          </div>
        `;
        
        modal.classList.add('active');
      } catch (e) {
        alert('Fehler beim Laden der Details');
        console.error(e);
      }
    }
    
    async function changeStatus(id) {
      const newStatus = document.getElementById('statusSelect').value;
      
      try {
        const response = await fetch(`/api/admin/reports/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });
        
        if (!response.ok) throw new Error('Fehler beim √Ñndern des Status');
        
        alert('Status ge√§ndert!');
        modal.classList.remove('active');
        loadReports(currentPage);
        loadStats();
      } catch (e) {
        alert('Fehler: ' + e.message);
      }
    }
    
    async function reforward(id) {
      const reason = prompt('Grund f√ºr erneute Weiterleitung:');
      if (!reason) return;
      
      try {
        const response = await fetch(`/api/admin/reports/${id}/reforward`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });
        
        const data = await response.json();
        
        if (!response.ok) throw new Error(data.message || 'Fehler');
        
        alert(`Meldung erneut an ${data.forwardedTo} weitergeleitet!`);
        modal.classList.remove('active');
        loadReports(currentPage);
      } catch (e) {
        alert('Fehler: ' + e.message);
      }
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleDateString('de-DE', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }
    
    function formatAuditAction(action) {
      const labels = {
        'CREATED': 'Erstellt',
        'FORWARDED': 'Weitergeleitet',
        'STATUS_CHANGED': 'Status ge√§ndert',
        'REFORWARDED': 'Erneut weitergeleitet',
        'DELETED': 'Gel√∂scht'
      };
      return labels[action] || action;
    }
  </script>
</body>
</html>
